<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movie Edge</title>
    {% load static %}
    <script type="text/javascript" src="{% static 'movie_edge/d3.min.js' %}"></script>
    <style>
        circle {
        {#fill: black;#}
        }
    </style>
</head>
<body>
<form action="{% url 'movie_edge:query_recommendations' %}" method="POST" id="sentimentForm">
    {% csrf_token %}
    {% for field in form %}
        <b>{{ field.label_tag }}</b> - {{ field }}
        <br>
    {% endfor %}
    <input type="submit" value="Submit">
</form>
</body>
<script>
    // https://stackoverflow.com/questions/38654599/django-best-way-to-pass-data-to-javascript
    const tableData = JSON.parse('{{ table_data|safe }}');
    console.log(tableData);
    const x_min = parseFloat(tableData['x__min']);
    const x_max = parseFloat(tableData['x__max']);
    const y_min = parseFloat(tableData['y__min']);
    const y_max = parseFloat(tableData['y__max']);
    const width = 1024;
    const height = 1024;
    const padding = 32;
    const MOVIE_ID = 'movie_id';
    const MOVIE_TITLE = 'movie_title';
    const TITLE = 'title';
    const GENRES = 'genres';
    const CLUSTER = 'cluster';
    const COLOR = 'color';
    const X = 'x';
    const Y = 'y';

    const data = tableData['data'].map(function (r) {
            r['movie_title'] = decodeURIComponent(r['movie_title']);
            return r
        }
    );

    const xScale = d3.scaleLinear().domain([x_min, x_max]).range([padding, width - padding]);
    const yScale = d3.scaleLinear().domain([y_min, y_max]).range([padding, height - padding]);

    const svg = d3.select('body').append('svg');

    svg.attr('width', 1024).attr('height', 1024)
        .call(d3.zoom().on("zoom", function () {
            svg.attr("transform", d3.event.transform)
        }))
        .append("g");

    svg.selectAll('.circle').data(data).enter()
        .append('circle')
        .attr('cx', function (d) {
            return xScale(d[X]);
        })
        .attr('cy', function (d) {
            return yScale(d[Y]);
        })
        .attr('r', 2)
        .attr('fill', function (d) {
            return d[COLOR];
        });

    document.forms['sentimentForm'].addEventListener('submit', (event) => {
        //https://stackoverflow.com/questions/374644/how-do-i-capture-response-of-form-submit
        event.preventDefault();
        fetch(event.target.action, {
            method: 'POST',
            body: new URLSearchParams(new FormData(event.target))
        }).then((resp) => {
            resp.json().then(function(j) {
                alert(j);
                console.log(j);
            });
        }).then((body) => {
            // doesn't seem necessary
        }).catch((error) => {
            console.log('Had Error!');
            console.log(error);
        });
    });

</script>
</html>