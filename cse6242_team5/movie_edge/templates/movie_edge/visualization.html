<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movie Edge</title>
    {% load static %}
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/png"/>
    <script type="text/javascript" src="{% static 'movie_edge/d3.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'movie_edge/grid_interactions.js' %}"></script>
    <script type="text/javascript" src="{% static 'movie_edge/constants.js' %}"></script>
    <script type="text/javascript" src="{% static 'movie_edge/bokeh-1.4.0.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'movie_edge/bokeh-api-1.4.0.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'movie_edge/bokeh-tables-1.4.0.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'movie_edge/bokeh-widgets-1.4.0.min.js' %}"></script>
    <style>
        .grid {
            display: grid;
            grid-gap: 10px;
            grid-template-columns: repeat(2, 50%);
            grid-template-rows: repeat(5, 17%);
            grid-auto-flow: column;
            width: 230px;
            height: 100%;
            float: left;
            position: relative;
        }

        .buttonSubmit {
            height: 80px;
            width: 9vw;
        }

        .buttonGetRandom {
            height: 80px;
            width: 9vw;
        }

        .buttonReset {
            height: 80px;
            width: 9vw;
        }

        .searchForm {
            height: 80px;
            width: 9vw;
            float: right;
        }

        .graph {
            width: calc(100% - 150px);
            height: 100%;
            float: right;
            background: darkgray;
            position: relative;
        }

        body {
            overflow-x: hidden;
            overflow-y: hidden
        }

        .box {
            display: flex;
            flex-flow: column;
            height: 100%;
            background: red;
        }

        .topL {
            background-color: dimgray;
            position: absolute;
            top: 0;
            left: 0;
            height: 90px;
            width: 50%;
        }

        .topR {
            background-color: dimgray;
            position: absolute;
            top: 0;
            right: 0;
            height: 90px;
            width: 50%;
            vertical-align: center;
            horiz-align: center;
        }

        .left-half {
            background-color: black;
            position: absolute;
            left: 0;
            top: 90px;
            width: 230px;
            height: 100%;
        }

        .right-half {
        / / background-color: rgb(39, 40, 34); /* monokai gray background */
            background-color: white;
            position: absolute;
            right: 0;
            top: 90px;
            width: calc(100% - 230px);
            height: 100%;
        }

        .smallImg {
            height: 33%;
            width: 33%;
        }

        button {
            background-color: white;
        }

        .screen-title {
            /*vertical-align: center;*/
            text-align: center;
            font-size: 200%;
            color: white;
        }

        .bk-root {
            width: 80%;
            top: 90px;
            float: right;
            background: darkgray;
        }

    </style>
</head>
<body>
<div class="topL" id="buttons">
    <button class="buttonSubmit" type="button" onclick="buttonClickSubmit(fetchURL)">
        Click for recommendations
    </button>
    <button class="buttonGetRandom" type="button" onclick="buttonClickGetRandom(fetchURL)">
        Click for random suggestions
    </button>
    <button class="buttonReset" type="button" onclick="resetZoom()">
        Reset Zoom
    </button>
    <form class="searchForm" action="javascript:;" onsubmit="findMovie(this)">
        <input type="text" name="movieRegex">
    </form>
</div>
<div class="topR" id="title">
    <h1 class="screen-title">Welcome to Movie Edge - Click a Movie to find it in the Taste Space</h1>
</div>

<!--https://gridbyexample.com/examples/code/example18.html-->
<div class="container">
    <div class="box">
        <div class="left-half grid" id="grid"></div>
        <div class="right-half graph" id="graph"></div>
    </div>
</div>

{#Begin: super necessary! Else, disable CSRF Protection in views.py #}
{% csrf_token %}
{#End: super necessary! Else, disable CSRF Protection in views.py #}
<script>
    // https://stackoverflow.com/questions/38654599/django-best-way-to-pass-data-to-javascript
    const tableData = JSON.parse('{{ table_data|safe }}');
    const payload = tableData.payload;

    console.log(tableData);
    const x_min = parseFloat(tableData['x__min']);
    const x_max = parseFloat(tableData['x__max']);
    const y_min = parseFloat(tableData['y__min']);
    const y_max = parseFloat(tableData['y__max']);
    const decoder = tableData['decoder'];
    const width = window.innerWidth; //0.7 *
    const height = window.innerHeight;
    const data = payload[5].map(inputFormat);

    const fetchURL = "{% url 'movie_edge:query_recommendations' %}";
    currentGrid = tableData[MOVIE_CHOICES];

    const plt = Bokeh.Plotting;
    const x = data.map(function (v) {
        return v[X]
    });
    const y = data.map(function (v) {
        return v[Y]
    });
    const titles = data.map(function (v) {
        return v[MOVIE_TITLE].toString()
    });

    const ratings = data.map(function (v) {
        let score = null;
        if (v[METASCORE] !== null) {
            console.log('Metascore');
            score = v[METASCORE];
        } else if (v[IMDB_RATING] !== null) {
            score = v[IMDB_RATING] * 10.0;
        } else {
            score = 0
        }
        return score
    });

    const colorScale = d3.scaleSequential(d3.interpolateViridis).domain([0, 100]);
    const colors = ratings.map(x => colorScale(x));
    const posters = data.map(x => x[POSTER_URL]);
    const source = new Bokeh.ColumnDataSource({
        data: {
            'x': x, 'y': y, 'color': colors, 'movie_title': titles,
            'rating': ratings, 'poster': posters
        }
    });

    const tools = "pan,crosshair,wheel_zoom,box_zoom,save";
    const xdr = new Bokeh.Range1d({start: x_min, end: x_max});
    const ydr = new Bokeh.Range1d({start: y_min, end: y_max});

    // https://stackoverflow.com/questions/31684523/use-the-hovertool-in-bokehjs
    const tooltip = ("<div><p>Title: @movie_title</p> " +
        "<p>Rating: @rating</p>" +
        "<p><img class='smallImg' src='@poster'></p></div>" +
        "<p>===</p>");
    const hover = new Bokeh.HoverTool({
        tooltips: tooltip
    });

    plotWidth = document.getElementById("graph").scrollWidth;
    plotHeight = document.getElementById("graph").scrollHeight;
    const p = plt.figure({
        title: "Movie Taste Space",
        tools: tools,
        x_range: xdr,
        y_range: ydr,
        plot_width: plotWidth - 30,
        plot_height: plotHeight - 120,
    });
    p.add_tools(hover);
    p.legend.click_policy = 'hide';

    // call the circle glyph method to add some circle glyphs
    const circles = p.circle({field: "x"}, {field: "y"}, {
        source: source,
        fill_color: {field: "color"},
        line_color: {field: "color"},
        radius: 0.1,
    });

    const text = p.text(
        {field: "x"},
        {field: "y"},
        {field: MOVIE_TITLE},
        {
            source: source,
            legend: 'Click to enable movie titles'
        },
    );
    text.visible = false;
    // show the plot
    new_plot = plt.show(p);
    gridMovies(tableData[MOVIE_CHOICES]); // since this calls highlightAndCenter, much of the setup above needs to be completed first

</script>
</body>
</html>