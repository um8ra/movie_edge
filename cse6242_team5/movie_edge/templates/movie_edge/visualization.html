<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movie Edge</title>
    {% load static %}
    <script type="text/javascript" src="{% static 'movie_edge/d3.min.js' %}"></script>

    <style>
        .wrapper {
            width: 1000px;
            display: grid;
            grid-gap: 10px;
            grid-template-columns: repeat(3, 200px);
            grid-template-rows: repeat(3, 350px);
            grid-auto-flow: column;
        }

        .buttonRecommend {
            height: 32px;
            width: 128px;
        }
    </style>
</head>
<body>
<button class="buttonRecommend" type="submit" formaction="{% url 'movie_edge:query_recommendations' %}"
        onclick="buttonClickSubmit()">
    Click me for movie recommendations!
</button>
<br>
<br>
<!--https://gridbyexample.com/examples/code/example18.html-->
<div class="wrapper" id="grid">
</div>
</body>
<script>
    // https://stackoverflow.com/questions/38654599/django-best-way-to-pass-data-to-javascript
    const tableData = JSON.parse('{{ table_data|safe }}');
    console.log(tableData);
    const x_min = parseFloat(tableData['x__min']);
    const x_max = parseFloat(tableData['x__max']);
    const y_min = parseFloat(tableData['y__min']);
    const y_max = parseFloat(tableData['y__max']);
    const decoder = tableData['decoder'];
    let nineChoices = tableData['random_nine'];
    const width = 1024;
    const height = 1024;
    const padding = 32;
    const MOVIE_ID = 'movie_id';
    const MOVIE_TITLE = 'movie_title';
    const DIRECTOR = 'director';
    const ACTORS = 'actors';
    const TITLE = 'title';
    const GENRES = 'genres';
    const CLUSTER = 'cluster';
    const COLOR = 'color';
    const POSTER_URL = 'poster_url';
    const MOVIE_CHOICES = 'movie_choices';
    const LIKE = 'movies_liked';
    const DISLIKE = 'movies_disliked';
    const X = 'x';
    const Y = 'y';
    const moviesLiked = new Set(); // using set since it will do deduplication
    const moviesDisliked = new Set(); // using set since it will do deduplication
    const POSTER_HEIGHT = 300;
    const POSTER_WIDTH = 200;

    const gridID = 'grid';
    const data = tableData['data'].map(function (r) {
            r[MOVIE_TITLE] = decodeURIComponent(r[MOVIE_TITLE]);
            r[DIRECTOR] = decodeURIComponent(r[DIRECTOR]);
            r[ACTORS] = decodeURIComponent(r[ACTORS]);
            return r
        }
    );

    function getCookie(name) {
        // https://docs.djangoproject.com/en/2.2/ref/csrf/
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function buttonClickSubmit() {
        console.log('Button Clicked');
        // https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
        const fetchPayload = Object();
        fetchPayload[LIKE] = Array.from(moviesLiked);
        fetchPayload[DISLIKE] = Array.from(moviesDisliked);
        const fetchURL = "{% url 'movie_edge:query_recommendations' %}";
        const fetchParams = {
            method: 'POST',
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                'Content-Type': 'application/json'
                {#'Content-Type': 'application/x-www-form-urlencoded'#}
            },
            body: JSON.stringify(fetchPayload),
            credentials: 'same-origin'
        };
        console.log(fetchParams);
        // https://scotch.io/tutorials/how-to-use-the-javascript-fetch-api-to-get-data
        // https://developers.google.com/web/fundamentals/primers/promises
        fetch(fetchURL, fetchParams)
            .then((response) => response.json())
            .then(function (data) {
                console.log(data);
                const movieChoices = data[MOVIE_CHOICES];
                console.log(movieChoices);
                gridNine(movieChoices);
            })
    }

    function buttonClickLike(data) {
        const movieId = data.target.value;
        if (moviesDisliked.has(movieId)) {
            moviesDisliked.delete(movieId);
        }
        moviesLiked.add(movieId);
        console.log(moviesLiked);
    }

    function buttonClickDislike(data) {
        const movieId = data.target.value;
        if (moviesLiked.has(movieId)) {
            moviesLiked.delete(movieId);
        }
        moviesDisliked.add(movieId);
        console.log(moviesDisliked);
    }

    function gridNine(movieidList) {
        // Delete current grid and redraw with new *choices*
        // https://stackoverflow.com/questions/3955229/remove-all-child-elements-of-a-dom-node-in-javascript
        const grid = document.getElementById(gridID);
        while (grid.firstChild) {
            grid.removeChild(grid.firstChild);
        }
        // https://stackoverflow.com/questions/2735881/adding-images-to-an-html-document-with-javascript
        movieidList.forEach(function (movieId) {
                const dataIndex = decoder[movieId];
                console.log(dataIndex);
                const divNode = document.createElement('div');
                const imgNode = document.createElement('img');
                const buttonLike = document.createElement('BUTTON');
                buttonLike.innerText = 'Like';
                buttonLike.onclick = buttonClickLike;
                buttonLike.value = movieId;
                const buttonDislike = document.createElement('BUTTON');
                buttonDislike.innerText = 'Dislike';
                buttonDislike.onclick = buttonClickDislike;
                buttonDislike.value = movieId;
                imgNode.src = data[dataIndex][POSTER_URL];
                imgNode.height = POSTER_HEIGHT;
                imgNode.width = POSTER_WIDTH;
                grid.appendChild(divNode);
                divNode.appendChild(imgNode);
                divNode.appendChild(buttonLike);
                divNode.appendChild(buttonDislike);
                console.log(movieId);
            }
        )
    }

    gridNine(nineChoices);
    const xScale = d3.scaleLinear().domain([x_min, x_max]).range([padding, width - padding]);
    const yScale = d3.scaleLinear().domain([y_min, y_max]).range([padding, height - padding]);

    const svg = d3.select('body').append('svg');

    svg.attr('width', 1024).attr('height', 1024)
        .call(d3.zoom().on("zoom", function () {
            svg.attr("transform", d3.event.transform)
        }))
        .append("g");

    svg.selectAll('.circle').data(data).enter()
        .append('circle')
        .attr('cx', function (d) {
            return xScale(d[X]);
        })
        .attr('cy', function (d) {
            return yScale(d[Y]);
        })
        .attr('r', 2)
        .attr('fill', function (d) {
            return d[COLOR];
        });
</script>
</html>